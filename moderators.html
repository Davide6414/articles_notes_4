<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Moderators</title>
    <link rel="stylesheet" href="project/assets/css/style.css" />
    <script src="project/assets/js/dataService.js"></script>
    <script src="project/assets/js/toast.js"></script>
    <style>
      :root {
        --gap: 12px;
        --border: 1px solid #dde4ed;
        --radius: 14px;
        --brand: #0f766e;
        --brand-2: #0ea5e9;
        --muted: #6b7280;
        --surface: #ffffff;
        --bg: #f5f8fb;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: #0f172a;
        background: var(--bg);
      }
      a { color: #0f766e; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .page-shell { max-width: 1120px; margin: 0 auto; padding: 28px 20px 96px; display: grid; gap: 14px; }
      .header {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
      }
      .title { margin: 0; font-size: 24px; letter-spacing: -0.01em; }
      .sub { color: var(--muted); font-size: 14px; margin-top: 4px; }
      .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .btn {
        font-size: 14px;
        padding: 9px 14px;
        border-radius: 10px;
        border: 1px solid #d7dee8;
        background: #fff;
        cursor: pointer;
        transition: transform 0.05s ease, box-shadow 0.15s ease, background 0.15s ease;
      }
      .btn:hover { background: #f1f5f9; }
      .btn:active { transform: translateY(1px); }
      .btn.primary { background: linear-gradient(90deg, #0f766e, #0ea5e9); border-color: #0ea5e9; color: #fff; box-shadow: 0 10px 20px rgba(14,165,233,0.18); }
      .btn.ghost { background: #ecfeff; border-color: #c8edf3; color: #0b4e54; }
      .eyebrow { text-transform: uppercase; letter-spacing: 0.08em; font-size: 11px; color: #0f766e; font-weight: 700; }
      .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #e7f7f4; color: #0f766e; border: 1px solid #cde9e4; font-size: 12px; }
      .panel {
        padding: 14px;
        border: var(--border);
        border-radius: var(--radius);
        background: var(--surface);
        display: grid;
        gap: 10px;
        box-shadow: 0 8px 28px rgba(15, 118, 110, 0.08);
      }
      .panel.highlight { background: linear-gradient(180deg, #f0fdf4, #e0f7ff); border-color: #c8e8d7; }
      .panel.slim { gap: 8px; }
      .intro-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
      .list-panel { gap: 12px; }
      .list-head { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
      .list-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
      .row { display: grid; gap: 6px; }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      label { font-size: 12px; color: #374151; }
      input[type="text"], input[type="search"], textarea, select {
        width: 100%;
        padding: 9px 10px;
        border: 1px solid #d0d7e2;
        border-radius: 10px;
        font-size: 14px;
        box-sizing: border-box;
        background: #f9fafb;
      }
      input:focus, textarea:focus, select:focus { outline: 2px solid #cce7ff; border-color: #8bc4f7; background: #fff; }
      textarea { resize: vertical; }
      .mini-list { margin: 0; padding-left: 18px; color: #334155; display: grid; gap: 4px; font-size: 13px; }
      .mods { display: grid; gap: 12px; }
      .muted { color: var(--muted); font-size: 12px; }
      .mod-card {
        border: 1px solid #dfe7ef;
        border-radius: 16px;
        padding: 12px;
        display: grid;
        gap: 10px;
        background: #fff;
        box-shadow: 0 8px 24px rgba(0,0,0,0.04);
      }
      .mod-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
      .mod-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #eef2ff; color: #4338ca; border: 1px solid #d8ddff; font-size: 12px; font-weight: 600; }
      .mod-block {
        border: 1px dashed #dce5f0;
        border-radius: 12px;
        padding: 10px;
        background: #f8fafc;
        display: grid;
        gap: 8px;
      }
      .block-head { display: flex; align-items: baseline; justify-content: space-between; gap: 8px; }
      .block-title { font-size: 14px; font-weight: 700; color: #0f172a; }
      .chips { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { font-size: 12px; padding: 5px 9px; border-radius: 9999px; border: 1px solid #d1d5db; background: #f8fafc; }
      .ref-suggestions { border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; max-height: 170px; overflow: auto; margin-top: 4px; box-shadow: 0 8px 18px rgba(0,0,0,0.08); }
      .ref-suggestion {
        padding: 8px 10px;
        font-size: 13px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
      }
      .ref-suggestion:hover { background: #ecfeff; }
      .small { font-size: 12px; color: var(--muted); }
      .sticky-save { position: sticky; bottom: 10px; z-index: 10; }
      .save-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 14px;
        background: #ffffff;
        border: 1px solid #d8e3ed;
        box-shadow: 0 16px 30px rgba(0,0,0,0.08);
        flex-wrap: wrap;
      }
      .bar-actions { display: flex; gap: 10px; flex-wrap: wrap; }
      @media (max-width: 920px) {
        .intro-grid { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr; }
      }
      @media (max-width: 640px) {
        .page-shell { padding: 20px 14px 90px; }
        .toolbar { width: 100%; justify-content: flex-start; }
        .mod-card { padding: 10px; }
      }
    </style>
  </head>
  <body>
    <div class="page-shell">
      <div class="header">
        <div>
          <h1 class="title">Moderators</h1>
          <div class="sub">Aggiungi più moderators per articoli diversi con una schermata unica e leggibile.</div>
        </div>
        <div class="toolbar">
          <a class="btn" href="index.html">Torna</a>
          <button id="addModBtn" class="btn ghost">+ Moderator</button>
        </div>
      </div>

      <div class="intro-grid">
        <div class="panel highlight">
          <div class="eyebrow">Come compilare</div>
          <div class="mini-list">
            <div>1. Seleziona l'articolo <strong>target</strong> dove salvare il moderator.</div>
            <div>2. Aggiungi effetto atteso e il tipo di reference che lo supporta.</div>
            <div>3. Scegli la reference cercandola nel DB e aggiungi tag utili.</div>
          </div>
          <div class="chips">
            <span class="chip">Ricerca veloce per titolo o DOI</span>
            <span class="chip">Tag multipli con la selezione a destra</span>
            <span class="chip">Puoi aggiungere più moderators prima di salvare</span>
          </div>
        </div>
        <div class="panel slim">
          <div class="eyebrow">Suggerimenti rapidi</div>
          <ul class="mini-list">
            <li>Il target è obbligatorio per il salvataggio.</li>
            <li>Reference e tipo aiutano a leggere in tabella.</li>
            <li>I tag riutilizzano quelli già presenti nel DB.</li>
          </ul>
        </div>
      </div>

      <div class="panel list-panel">
        <div class="list-head">
          <div>
            <div class="eyebrow">Inserimento moderators</div>
            <div class="title" style="font-size:20px; margin: 4px 0 2px;">Elenco da salvare</div>
            <div class="sub">Blocchi separati e ordinati per compilare senza confusione.</div>
          </div>
          <div class="toolbar">
            <button id="addModBtnInline" class="btn">+ Moderator</button>
          </div>
        </div>
        <div class="list-meta">
          <span id="modsCounter" class="pill">Nessun moderator in compilazione</span>
          <span class="muted">Ogni card raccoglie destinazione, reference e tag.</span>
        </div>
        <div id="mods" class="mods"></div>
      </div>

      <div class="sticky-save">
        <div class="save-bar">
          <div>
            <div class="eyebrow">Azioni veloci</div>
            <div id="stickyCount" class="title" style="font-size:16px; margin: 4px 0 0;">Nessun moderator in lista</div>
            <div class="muted">Il salvataggio aggiunge i moderators ai rispettivi articoli target.</div>
          </div>
          <div class="bar-actions">
            <button id="addModBottomBtn" class="btn ghost">+ Moderator</button>
            <button id="saveBtn" class="btn primary">Salva moderators</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const addModBtn = document.getElementById('addModBtn');
        const addModBtnInline = document.getElementById('addModBtnInline');
        const addModBottomBtn = document.getElementById('addModBottomBtn');
        const saveBtn = document.getElementById('saveBtn');
        const modsEl = document.getElementById('mods');
        const modsCounter = document.getElementById('modsCounter');
        const stickyCount = document.getElementById('stickyCount');

        const params = new URLSearchParams(location.search);
        const initialDOI = params.get('doi') || '';

        let db = {};
        let dois = [];
        let articlesIndex = [];
        let items = [];
        let tagFacetValues = [];

        function updateCounters(){
          const count = items.length;
          const label = count ? `${count} moderator${count > 1 ? 'i' : ''} in compilazione` : 'Nessun moderator in compilazione';
          if (modsCounter) modsCounter.textContent = label;
          if (stickyCount) stickyCount.textContent = count ? `${count} pronto${count > 1 ? 'i' : ''} al salvataggio` : 'Nessun moderator in lista';
        }

        function splitCsv(str){ return (str||'').split(',').map(s=>s.trim()).filter(Boolean); }

        function uuid(){
          try { return crypto.randomUUID(); }
          catch(_) { return 'mod_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1e6).toString(36); }
        }

        function getTitle(entry){
          if (!entry) return '';
          const t = entry.title;
          if (Array.isArray(t) && t.length) return t.join(' - ');
          if (typeof t === 'string') return t;
          return '';
        }

        async function loadAll(){
          try { db = await DataService.getAll(); } catch(e){ db = {}; }
          dois = Object.keys(db).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
          articlesIndex = dois.map(doi => {
            const entry = db[doi] || {};
            const title = getTitle(entry) || doi;
            return { doi, title, label: title + ' — ' + doi };
          });
          computeTagFacets();
          if (!items.length) {
            addEmpty(initialDOI && db[initialDOI] ? initialDOI : '');
          } else {
            renderList();
          }
        }

        function computeTagFacets(){
          const set = new Set();
          try {
            Object.keys(db||{}).forEach(doi => {
              const entry = db[doi] || {};
              // Tags da note
              const notes = Array.isArray(entry.user_notes) ? entry.user_notes : (entry.user_note ? [entry.user_note] : []);
              notes.forEach(n => {
                const ts = Array.isArray(n && n.tags) ? n.tags : (n && n.tags ? [String(n.tags)] : []);
                ts.forEach(t => { const k = String(t).trim(); if (k) set.add(k); });
              });
              // Tags da moderators
              const mods = Array.isArray(entry.user_moderators) ? entry.user_moderators : [];
              mods.forEach(m => {
                const ts = Array.isArray(m && m.tags) ? m.tags : (m && m.tags ? [String(m.tags)] : []);
                ts.forEach(t => { const k = String(t).trim(); if (k) set.add(k); });
              });
            });
          } catch (_) {}
          tagFacetValues = Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'}));
        }

        function addEmpty(targetDoi){
          items.push({
            id: uuid(),
            targetDoi: targetDoi || '',
            name: '',
            expectedEffect: '',
            referenceDoi: '',
            referenceTitle: '',
            refType: '',
            tagsText: ''
          });
          renderList();
        }

        function handleAdd(){
          addEmpty(initialDOI && db[initialDOI] ? initialDOI : '');
        }

        [addModBtn, addModBtnInline, addModBottomBtn].forEach(btn => {
          if (btn) btn.addEventListener('click', handleAdd);
        });

        function renderList(){
          modsEl.innerHTML = '';
          if (!items.length) {
            const empty = document.createElement('div');
            empty.className = 'muted';
            empty.textContent = 'Nessun moderator. Clicca "+ Moderator" per aggiungerne uno.';
            modsEl.appendChild(empty);
            updateCounters();
            return;
          }

          items.forEach((it, idx) => {
            const card = document.createElement('div'); card.className = 'mod-card';

            const head = document.createElement('div'); head.className = 'mod-head';
            const headLeft = document.createElement('div'); headLeft.style.display = 'grid'; headLeft.style.gap = '4px';
            const badge = document.createElement('span'); badge.className = 'mod-chip'; badge.textContent = `Moderator ${idx+1}`;
            const hint = document.createElement('div'); hint.className = 'muted'; hint.textContent = 'Compila i campi e assegna target + reference';
            headLeft.appendChild(badge); headLeft.appendChild(hint);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn';
            removeBtn.textContent = 'Rimuovi';
            removeBtn.addEventListener('click', () => {
              items = items.filter(x => x !== it);
              renderList();
            });
            head.appendChild(headLeft); head.appendChild(removeBtn);
            card.appendChild(head);

            // Target article
            const targetBlock = document.createElement('div'); targetBlock.className = 'mod-block';
            const targetHeader = document.createElement('div'); targetHeader.className = 'block-head';
            const targetTitle = document.createElement('div'); targetTitle.className = 'block-title'; targetTitle.textContent = 'Dove salvare';
            const targetHint = document.createElement('div'); targetHint.className = 'small'; targetHint.textContent = 'Seleziona l\'articolo target (obbligatorio)';
            targetHeader.appendChild(targetTitle); targetHeader.appendChild(targetHint);
            targetBlock.appendChild(targetHeader);

            const targetRow = document.createElement('div'); targetRow.className = 'row';
            targetRow.appendChild(Object.assign(document.createElement('label'), { textContent: 'Articolo target (dove salvare il moderator)' }));
            const targetInput = document.createElement('input');
            targetInput.type = 'search';
            targetInput.placeholder = 'Digita parte del titolo o DOI';
            if (it.targetDoi && db[it.targetDoi]) {
              targetInput.value = getTitle(db[it.targetDoi]) || it.targetDoi;
            }
            const targetInfo = document.createElement('div'); targetInfo.className = 'small';
            const targetBox = document.createElement('div'); targetBox.className = 'ref-suggestions'; targetBox.style.display = 'none';

            function updateTargetInfo(){
              if (it.targetDoi) {
                const entry = db[it.targetDoi];
                const titleTxt = getTitle(entry) || it.targetDoi;
                targetInfo.textContent = `Articolo target: ${titleTxt} (${it.targetDoi})`;
              } else {
                targetInfo.textContent = 'Nessun articolo target selezionato.';
              }
            }

            function searchTarget(){
              const q = (targetInput.value || '').toLowerCase().trim();
              targetBox.innerHTML = '';
              if (!q) { targetBox.style.display = 'none'; return; }
              const matches = articlesIndex.filter(a =>
                a.title.toLowerCase().includes(q) ||
                a.doi.toLowerCase().includes(q)
              ).slice(0, 10);
              if (!matches.length) { targetBox.style.display = 'none'; return; }
              matches.forEach(m => {
                const row = document.createElement('div'); row.className = 'ref-suggestion';
                const t = document.createElement('div'); t.textContent = m.title; row.appendChild(t);
                const d = document.createElement('div'); d.className = 'small'; d.textContent = m.doi; row.appendChild(d);
                row.addEventListener('click', () => {
                  it.targetDoi = m.doi;
                  targetInput.value = m.title;
                  targetBox.style.display = 'none';
                  updateTargetInfo();
                });
                targetBox.appendChild(row);
              });
              targetBox.style.display = 'block';
            }

            targetInput.addEventListener('input', searchTarget);
            targetInput.addEventListener('focus', searchTarget);
            document.addEventListener('click', (ev) => {
              if (!targetBox.contains(ev.target) && ev.target !== targetInput) {
                targetBox.style.display = 'none';
              }
            });

            targetRow.appendChild(targetInput);
            targetRow.appendChild(targetBox);
            targetRow.appendChild(targetInfo);
            updateTargetInfo();
            targetBlock.appendChild(targetRow);
            card.appendChild(targetBlock);

            // Nome moderator + Expected effect + Tipo
            const detailBlock = document.createElement('div'); detailBlock.className = 'mod-block';
            const detailHeader = document.createElement('div'); detailHeader.className = 'block-head';
            const detailTitle = document.createElement('div'); detailTitle.className = 'block-title'; detailTitle.textContent = 'Contenuto';
            const detailHint = document.createElement('div'); detailHint.className = 'small'; detailHint.textContent = 'Nome, effetto atteso e tipo di reference';
            detailHeader.appendChild(detailTitle); detailHeader.appendChild(detailHint);
            detailBlock.appendChild(detailHeader);

            const nameRow = document.createElement('div'); nameRow.className = 'row';
            nameRow.appendChild(Object.assign(document.createElement('label'), { textContent: 'Nome moderator' }));
            const nameIn = document.createElement('input');
            nameIn.type = 'text';
            nameIn.placeholder = 'es. habitat connectivity, flow regime';
            nameIn.value = it.name || '';
            nameIn.addEventListener('input', () => { it.name = nameIn.value; });
            nameRow.appendChild(nameIn);
            detailBlock.appendChild(nameRow);

            const effectWrap = document.createElement('div'); effectWrap.className = 'grid-2';
            const effCol = document.createElement('div'); effCol.className = 'row';
            effCol.appendChild(Object.assign(document.createElement('label'), { textContent: 'Expected effect' }));
            const effTa = Object.assign(document.createElement('textarea'), { rows: 3, value: it.expectedEffect || '' });
            effTa.addEventListener('input', () => { it.expectedEffect = effTa.value; });
            effCol.appendChild(effTa);
            effectWrap.appendChild(effCol);

            const typeCol = document.createElement('div'); typeCol.className = 'row';
            typeCol.appendChild(Object.assign(document.createElement('label'), { textContent: 'Tipo reference' }));
            const typeIn = document.createElement('input');
            typeIn.type = 'text';
            typeIn.setAttribute('list', 'modTypeList');
            typeIn.value = it.refType || '';
            typeIn.placeholder = 'es. review, primary study, meta-analysis';
            typeIn.addEventListener('input', () => { it.refType = typeIn.value; });
            typeCol.appendChild(typeIn);
            effectWrap.appendChild(typeCol);

            detailBlock.appendChild(effectWrap);
            card.appendChild(detailBlock);

            // Reference search
            const refBlock = document.createElement('div'); refBlock.className = 'mod-block';
            const refHeader = document.createElement('div'); refHeader.className = 'block-head';
            const refTitle = document.createElement('div'); refTitle.className = 'block-title'; refTitle.textContent = 'Reference di supporto';
            const refHint = document.createElement('div'); refHint.className = 'small'; refHint.textContent = 'Cerca il titolo o DOI presente nel DB';
            refHeader.appendChild(refTitle); refHeader.appendChild(refHint);
            refBlock.appendChild(refHeader);

            const refRow = document.createElement('div'); refRow.className = 'row';
            refRow.appendChild(Object.assign(document.createElement('label'), { textContent: 'Reference (cerca titolo articolo in DB)' }));
            const refInput = Object.assign(document.createElement('input'), {
              type:'search',
              placeholder:'Digita parte del titolo o DOI',
              value: it.referenceTitle || ''
            });
            const refInfo = document.createElement('div'); refInfo.className = 'small';
            const refBox = document.createElement('div'); refBox.className = 'ref-suggestions'; refBox.style.display = 'none';

            function updateRefInfo(){
              if (it.referenceDoi) {
                refInfo.textContent = `Selezionata: ${it.referenceTitle || it.referenceDoi} (${it.referenceDoi})`;
              } else {
                refInfo.textContent = 'Nessuna reference selezionata.';
              }
            }

            function doSearch(){
              const q = (refInput.value || '').toLowerCase().trim();
              refBox.innerHTML = '';
              if (!q) { refBox.style.display = 'none'; return; }
              const matches = articlesIndex.filter(a =>
                a.title.toLowerCase().includes(q) ||
                a.doi.toLowerCase().includes(q)
              ).slice(0, 10);
              if (!matches.length) { refBox.style.display = 'none'; return; }
              matches.forEach(m => {
                const row = document.createElement('div'); row.className = 'ref-suggestion';
                const t = document.createElement('div'); t.textContent = m.title; row.appendChild(t);
                const d = document.createElement('div'); d.className = 'small'; d.textContent = m.doi; row.appendChild(d);
                row.addEventListener('click', () => {
                  it.referenceDoi = m.doi;
                  it.referenceTitle = m.title;
                  refInput.value = m.title;
                  refBox.style.display = 'none';
                  updateRefInfo();
                });
                refBox.appendChild(row);
              });
              refBox.style.display = 'block';
            }

            refInput.addEventListener('input', doSearch);
            refInput.addEventListener('focus', doSearch);
            document.addEventListener('click', (ev) => {
              if (!refBox.contains(ev.target) && ev.target !== refInput) {
                refBox.style.display = 'none';
              }
            });

            refRow.appendChild(refInput);
            refRow.appendChild(refBox);
            refRow.appendChild(refInfo);
            updateRefInfo();
            refBlock.appendChild(refRow);
            card.appendChild(refBlock);

            // Tags
            const tagsBlock = document.createElement('div'); tagsBlock.className = 'mod-block';
            const tagsHeader = document.createElement('div'); tagsHeader.className = 'block-head';
            const tagsTitle = document.createElement('div'); tagsTitle.className = 'block-title'; tagsTitle.textContent = 'Tag';
            const tagsHint = document.createElement('div'); tagsHint.className = 'small'; tagsHint.textContent = 'Separali con virgola o scegli tra quelli suggeriti';
            tagsHeader.appendChild(tagsTitle); tagsHeader.appendChild(tagsHint);
            tagsBlock.appendChild(tagsHeader);

            const tagsRow = document.createElement('div'); tagsRow.className = 'row';
            tagsRow.appendChild(Object.assign(document.createElement('label'), { textContent: 'Tag (separati da virgola)' }));
            const tagsIn = Object.assign(document.createElement('input'), {
              type:'text',
              placeholder:'es. habitat, management, hydropower',
              value: it.tagsText || ''
            });
            const tagsChips = document.createElement('div'); tagsChips.className = 'chips';
            function renderTags(){
              tagsChips.innerHTML = '';
              splitCsv(tagsIn.value).forEach(t => {
                const c = document.createElement('span'); c.className = 'chip'; c.textContent = t; tagsChips.appendChild(c);
              });
            }
            tagsIn.addEventListener('input', () => { it.tagsText = tagsIn.value; renderTags(); });
            tagsRow.appendChild(tagsIn);
            tagsRow.appendChild(tagsChips);
            renderTags();

            if (tagFacetValues.length) {
              const labelSel = document.createElement('div');
              labelSel.className = 'small';
              labelSel.textContent = 'Tag esistenti (selezione multipla):';
              tagsRow.appendChild(labelSel);
              const tagSelect = document.createElement('select');
              tagSelect.multiple = true;
              tagSelect.size = Math.min(10, Math.max(4, tagFacetValues.length));
              tagFacetValues.forEach(t => {
                const op = document.createElement('option'); op.value = t; op.textContent = t; tagSelect.appendChild(op);
              });
              tagSelect.addEventListener('change', () => {
                const chosen = Array.from(tagSelect.selectedOptions).map(o => o.value);
                const manual = splitCsv(tagsIn.value);
                const merged = Array.from(new Set([].concat(manual, chosen)));
                tagsIn.value = merged.join(', ');
                it.tagsText = tagsIn.value;
                renderTags();
              });
              tagsRow.appendChild(tagSelect);
            }

            tagsBlock.appendChild(tagsRow);
            card.appendChild(tagsBlock);

            modsEl.appendChild(card);
          });

          updateCounters();
        }

        async function save(){
          // Raggruppa i moderators per articolo target
          const byDoi = new Map();
          items.forEach(it => {
            const doi = (it.targetDoi || '').trim();
            if (!doi) return;
            // ignora righe completamente vuote
            const hasContent = (it.name && it.name.trim()) ||
                               (it.expectedEffect && it.expectedEffect.trim()) ||
                               (it.referenceDoi && it.referenceDoi.trim()) ||
                               (it.refType && it.refType.trim()) ||
                               (splitCsv(it.tagsText).length > 0);
            if (!hasContent) return;
            if (!byDoi.has(doi)) byDoi.set(doi, []);
            byDoi.get(doi).push(it);
          });

          if (!byDoi.size) {
            alert('Nessun moderator valido da salvare. Assicurati di aver selezionato un articolo target e compilato almeno qualche campo.');
            return;
          }

          try {
            const full = await DataService.getAll();
            const tid = Toast ? Toast.loading('Salvataggio moderators...') : null;

            for (const [doi, list] of byDoi.entries()){
              const base = full[doi] || { DOI: doi };
              const combined = Object.assign({}, base);
              const existing = Array.isArray(combined.user_moderators) ? combined.user_moderators.slice() : [];
              list.forEach(src => {
                const tags = splitCsv(src.tagsText);
                const now = new Date().toISOString();
                const mod = {
                  id: src.id || uuid(),
                  doi,
                  name: (src.name || '').trim() || null,
                  expectedEffect: (src.expectedEffect || '').trim() || null,
                  referenceDoi: (src.referenceDoi || '').trim() || null,
                  referenceTitle: (src.referenceTitle || '').trim() || null,
                  refType: (src.refType || '').trim() || null,
                  tags,
                  createdAt: now
                };
                existing.push(mod);
              });
              combined.user_moderators = existing;
              await DataService.saveRecord(doi, combined);
            }

            if (tid && Toast.update) {
              Toast.update(tid, 'Moderators salvati', 'success');
              setTimeout(() => Toast.dismiss(tid), 800);
            }

            // Reset state and torna alla pagina iniziale per evitare salvataggi doppi
            items = [];
            renderList();
            setTimeout(() => { window.location.href = 'index.html'; }, 300);
          } catch (e) {
            console.error('Errore salvataggio moderators', e);
            if (Toast && Toast.error) Toast.error('Errore salvataggio moderators');
            alert('Errore durante il salvataggio dei moderators');
          }
        }

        saveBtn.addEventListener('click', save);

        const dl = document.createElement('datalist'); dl.id = 'modTypeList';
        ['primary study', 'review', 'meta-analysis', 'methodological', 'case study'].forEach(v => {
          const op = document.createElement('option'); op.value = v; dl.appendChild(op);
        });
        document.body.appendChild(dl);

        loadAll();
      })();
    </script>
  </body>
  </html>
