<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tabella Variabili</title>
    <link rel="stylesheet" href="project/assets/css/style.css" />
    <script src="project/assets/js/dataService.js"></script>
    <style>
      :root { --gap: 12px; --border: 1px solid #e5e7eb; --radius: 12px; }
      body { margin: 2rem; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: #111827; }
      a { color: #2563eb; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .header { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; margin-bottom: 16px; }
      .title { margin: 0; font-size: 22px; }
      .sub { color: #6b7280; font-size: 13px; }
      .toolbar { display: flex; gap: 8px; align-items: center; }
      .btn { font-size: 14px; padding: 8px 12px; border-radius: 8px; border: 1px solid #d0d0d0; background: #fff; cursor: pointer; }
      .btn:hover { background: #f6f6f6; }
      .filter { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
      input[type="search"] { width: 100%; padding: 8px 10px; border: 1px solid #d0d0d0; border-radius: 8px; font-size: 14px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 13px; vertical-align: top; }
      th { background: #f9fafb; text-align: left; position: sticky; top: 0; z-index: 1; }
      .muted { color: #6b7280; }
      .nowrap { white-space: nowrap; }
      .num { text-align: right; font-variant-numeric: tabular-nums; }
      .small { font-size: 12px; color: #6b7280; }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1 class="title">Tabella Variabili</h1>
        <div class="sub">Riepilogo per articolo e variabile</div>
      </div>
      <div class="toolbar">
        <a class="btn" href="index.html">← Torna</a>
        <a class="btn" href="variabili.html">Gestisci variabili</a>
      </div>
    </div>

    <div class="filter">
      <input id="searchTitle" type="search" placeholder="Cerca per titolo o DOI" />
      <input id="searchVar" type="search" placeholder="Cerca per nome variabile" />
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Titolo</th>
            <th class="nowrap">DOI</th>
            <th>Variabile</th>
            <th>Unità</th>
            <th>Nota</th>
            <th class="nowrap">Modalità</th>
            <th colspan="3">Semplice (valore, sd, n)</th>
            <th colspan="3">Controllo (media, sd, n)</th>
            <th colspan="3">Impattata (media, sd, n)</th>
            <th colspan="2">Effect size (Hedges g, Var)</th>
            <th colspan="2">lnRR (ln ratio, Var)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <script>
      (function(){
        const tbody = document.getElementById('tbody');
        const searchTitle = document.getElementById('searchTitle');
        const searchVar = document.getElementById('searchVar');

        let db = {};
        let rows = [];

        function getTitle(entry){
          if(!entry) return '';
          const t = entry.title;
          if(Array.isArray(t)&&t.length) return t.join(' — ');
          if(typeof t==='string') return t;
          return '';
        }

        function numberOrNull(v){ const x = parseFloat(v); return isFinite(x) ? x : null; }
        function computeEffects(it){
          const out = {};
          if (it.meta) {
            const mc = numberOrNull(it.control?.mean);
            const sc = numberOrNull(it.control?.sd);
            const nc = numberOrNull(it.control?.n);
            const mt = numberOrNull(it.impacted?.mean);
            const st = numberOrNull(it.impacted?.sd);
            const nt = numberOrNull(it.impacted?.n);
            if (mc!=null && sc!=null && nc && mt!=null && st!=null && nt) {
              const sp2 = (((nc-1)*(sc*sc)) + ((nt-1)*(st*st))) / ((nc+nt)-2);
              const sp = Math.sqrt(Math.max(sp2, 0));
              if (sp>0) {
                const d = (mt - mc) / sp;
                const J = 1 - (3/(4*(nc+nt) - 9));
                const g = J * d;
                const var_d = (nc+nt)/(nc*nt) + (d*d)/(2*(nc+nt - 2));
                const var_g = J*J * var_d;
                out.smd_g = g;
                out.var_g = var_g;
              }
              if (mc>0 && mt>0) {
                const lnrr = Math.log(mt/mc);
                const var_lnrr = (st*st)/(nt*mt*mt) + (sc*sc)/(nc*mc*mc);
                out.lnrr = lnrr;
                out.var_lnrr = var_lnrr;
              }
            }
          }
          return out;
        }

        function fmt(x, digits=3){ return (typeof x === 'number' && isFinite(x)) ? x.toFixed(digits) : ''; }

        function labelSuffixes(list){
          // list of rows for a single DOI; suffix duplicates (a)(b)(c)
          const map = new Map();
          const totals = new Map();
          list.forEach(r => { const key = (r.name||'').trim().toLowerCase(); totals.set(key, (totals.get(key)||0)+1); });
          return list.map(r => {
            const key = (r.name||'').trim().toLowerCase();
            const total = totals.get(key)||0;
            if (total <= 1 || !r.name) { r.displayName = r.name||''; return r; }
            const idx = (map.get(key)||0)+1; map.set(key, idx);
            const letter = String.fromCharCode('a'.charCodeAt(0) + (idx - 1));
            r.displayName = `${r.name} (${letter})`;
            return r;
          });
        }

        function render(){
          const qTitle = (searchTitle.value||'').toLowerCase().trim();
          const qVar = (searchVar.value||'').toLowerCase().trim();
          tbody.innerHTML = '';
          // apply labels per DOI before filtering by var
          const byDoi = new Map();
          rows.forEach(r => { const arr = byDoi.get(r.doi) || []; arr.push(Object.assign({}, r)); byDoi.set(r.doi, arr); });
          let prepared = [];
          for (const [doi, arr] of byDoi.entries()) {
            prepared = prepared.concat(labelSuffixes(arr));
          }

          const filtered = prepared.filter(r => {
            const matchTitle = !qTitle || r.title.toLowerCase().includes(qTitle) || r.doi.toLowerCase().includes(qTitle);
            const matchVar = !qVar || ((r.displayName||r.name||'').toLowerCase().includes(qVar));
            return matchTitle && matchVar;
          });
          if (!filtered.length) {
            const tr = document.createElement('tr');
            const td = document.createElement('td'); td.colSpan = 17; td.className='muted'; td.textContent = 'Nessun risultato'; tr.appendChild(td); tbody.appendChild(tr); return;
          }
          for (const r of filtered) {
            const tr = document.createElement('tr');
            function td(txt, cls){ const el=document.createElement('td'); if (cls) el.className = cls; el.textContent = (txt==null?'':String(txt)); return el; }
            tr.appendChild(td(r.title));
            const doiCell = document.createElement('td'); doiCell.className='nowrap'; const a=document.createElement('a'); a.href=`details.html?doi=${encodeURIComponent(r.doi)}`; a.textContent=r.doi; doiCell.appendChild(a); tr.appendChild(doiCell);
            tr.appendChild(td(r.displayName || r.name));
            tr.appendChild(td(r.unit));
            tr.appendChild(td((r.note && r.note.trim()) ? r.note : 'no note'));
            tr.appendChild(td(r.meta ? 'meta' : 'semplice', 'nowrap'));
            // semplice
            tr.appendChild(td(r.simple?.value, 'num'));
            tr.appendChild(td(r.simple?.sd, 'num'));
            tr.appendChild(td(r.simple?.n, 'num'));
            // controllo
            tr.appendChild(td(r.control?.mean, 'num'));
            tr.appendChild(td(r.control?.sd, 'num'));
            tr.appendChild(td(r.control?.n, 'num'));
            // impattata
            tr.appendChild(td(r.impacted?.mean, 'num'));
            tr.appendChild(td(r.impacted?.sd, 'num'));
            tr.appendChild(td(r.impacted?.n, 'num'));
            // effects
            const eff = r.effects && (typeof r.effects === 'object') ? r.effects : computeEffects(r);
            tr.appendChild(td(fmt(eff.smd_g), 'num'));
            tr.appendChild(td(fmt(eff.var_g, 4), 'num'));
            tr.appendChild(td(fmt(eff.lnrr), 'num'));
            tr.appendChild(td(fmt(eff.var_lnrr, 4), 'num'));
            tbody.appendChild(tr);
          }
        }

        async function load(){
          try {
            db = await DataService.getAll();
            const dois = Object.keys(db);
            rows = [];
            for (const doi of dois) {
              const entry = db[doi];
              const title = getTitle(entry) || doi;
              const arr = Array.isArray(entry?.dati_variabili) ? entry.dati_variabili : [];
              for (const it of arr) {
                rows.push(Object.assign({ doi, title }, it));
              }
            }
            render();
          } catch (e) {
            console.error('Caricamento fallito', e);
          }
        }

        searchTitle.addEventListener('input', render);
        searchVar.addEventListener('input', render);
        load();
      })();
    </script>
  </body>
  </html>
