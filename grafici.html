<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tabella Grafici (Effect sizes)</title>
    <link rel="stylesheet" href="project/assets/css/style.css" />
    <script src="project/assets/js/dataService.js"></script>
    <script src="project/assets/js/toast.js"></script>
    <style>
      :root { --gap: 12px; --border: 1px solid #e5e7eb; --radius: 12px; }
      body { margin: 2rem; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: #111827; }
      a { color: #2563eb; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .header { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; margin-bottom: 16px; }
      .title { margin: 0; font-size: 22px; }
      .toolbar { display: flex; gap: 8px; align-items: center; }
      .btn { font-size: 14px; padding: 8px 12px; border-radius: 8px; border: 1px solid #d0d0d0; background: #fff; cursor: pointer; }
      .btn:hover { background: #f6f6f6; }
      select, input[type="search"] { padding: 8px 10px; border: 1px solid #d0d0d0; border-radius: 8px; font-size: 14px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #e5e7eb; padding: 8px 10px; vertical-align: top; }
      th { background: #f9fafb; text-align: left; }
      .small { font-size: 12px; color: #6b7280; }
      .legend { display: flex; flex-wrap: wrap; gap: 6px; }
      .legend-item { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 9999px; border: 1px solid #e5e7eb; background: #fff; font-size: 12px; }
      .swatch { width: 10px; height: 10px; border-radius: 9999px; border: 1px solid #e5e7eb; }
      .nowrap { white-space: nowrap; }
      .muted { color: #6b7280; }
      .controls { display: flex; gap: 8px; align-items: center; justify-content: flex-end; margin-bottom: 12px; }
      .svg-wrap { overflow-x: auto; }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1 class="title">Tabella grafici (effect size)</h1>
      </div>
      <div class="toolbar">
        <a class="btn" href="index.html">← Torna</a>
        <a class="btn" href="variabili.html">Variabili</a>
      </div>
    </div>

    <div class="controls">
      <label>Tipo effect size
        <select id="effectType">
          <option value="g">Hedges g</option>
          <option value="lnrr">lnRR</option>
        </select>
      </label>
      <input id="searchVar" type="search" placeholder="Cerca per variabile" />
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="nowrap">Variabile</th>
            <th class="nowrap">N studi</th>
            <th>Grafico (95% CI)</th>
            <th>Legenda (Titoli)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <script>
      (function(){
        const tbody = document.getElementById('tbody');
        const effectTypeEl = document.getElementById('effectType');
        const searchVarEl = document.getElementById('searchVar');

        let db = {};
        let groups = [];

        function getTitle(entry){
          if(!entry) return '';
          const t = entry.title;
          if(Array.isArray(t)&&t.length) return t.join(' — ');
          if(typeof t==='string') return t;
          return '';
        }

        function numberOrNull(v){ const x = parseFloat(v); return isFinite(x) ? x : null; }
        function computeEffects(it){
          const out = {};
          if (it.meta) {
            const mc = numberOrNull(it.control?.mean);
            const sc = numberOrNull(it.control?.sd);
            const nc = numberOrNull(it.control?.n);
            const mt = numberOrNull(it.impacted?.mean);
            const st = numberOrNull(it.impacted?.sd);
            const nt = numberOrNull(it.impacted?.n);
            if (mc!=null && sc!=null && nc && mt!=null && st!=null && nt) {
              const sp2 = (((nc-1)*(sc*sc)) + ((nt-1)*(st*st))) / ((nc+nt)-2);
              const sp = Math.sqrt(Math.max(sp2, 0));
              if (sp>0) {
                const d = (mt - mc) / sp;
                const J = 1 - (3/(4*(nc+nt) - 9));
                const g = J * d;
                const var_d = (nc+nt)/(nc*nt) + (d*d)/(2*(nc+nt - 2));
                const var_g = J*J * var_d;
                out.smd_g = g;
                out.var_g = var_g;
              }
              if (mc>0 && mt>0) {
                const lnrr = Math.log(mt/mc);
                const var_lnrr = (st*st)/(nt*mt*mt) + (sc*sc)/(nc*mc*mc);
                out.lnrr = lnrr;
                out.var_lnrr = var_lnrr;
              }
            }
          }
          return out;
        }

        function groupByVariable(rows){
          const map = new Map();
          for (const r of rows) {
            const key = (r.name || '').trim().toLowerCase();
            if (!key) continue;
            const arr = map.get(key) || [];
            arr.push(r);
            map.set(key, arr);
          }
          const out = [];
          for (const [key, arr] of map.entries()) {
            if (arr.length < 2) continue; // mostriamo gruppi con multipli effect size
            out.push({ key, display: arr[0].name || key, items: arr });
          }
          // ordina alfabeticamente
          out.sort((a,b)=> a.display.localeCompare(b.display, undefined, {sensitivity:'base'}));
          return out;
        }

        function colorFor(str){
          let h=0; for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) % 360;
          return `hsl(${h} 70% 60%)`;
        }

        function render(){
          const type = effectTypeEl.value; // 'g' | 'lnrr'
          const q = (searchVarEl.value||'').toLowerCase().trim();
          tbody.innerHTML = '';
          const filteredGroups = groups.filter(g => !q || g.display.toLowerCase().includes(q));
          if (!filteredGroups.length) {
            const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=4; td.className='muted'; td.textContent='Nessun gruppo con multipli effect size.'; tr.appendChild(td); tbody.appendChild(tr); return;
          }
          for (const g of filteredGroups) {
            // estrai items validi (effect, var) e calcola pooled (fixed-effect)
            const items = g.items.map(it => {
              const eff = (it.effects && typeof it.effects==='object') ? it.effects : computeEffects(it);
              if (type === 'g') {
                if (typeof eff.smd_g === 'number' && typeof eff.var_g === 'number' && eff.var_g > 0) {
                  return { key: it.id || it.name, doi: it.doi || it._doi || '', title: it.title || '', effect: eff.smd_g, var: eff.var_g };
                }
              } else {
                if (typeof eff.lnrr === 'number' && typeof eff.var_lnrr === 'number' && eff.var_lnrr > 0) {
                  return { key: it.id || it.name, doi: it.doi || it._doi || '', title: it.title || '', effect: eff.lnrr, var: eff.var_lnrr };
                }
              }
              return null;
            }).filter(Boolean);
            if (items.length === 0) continue;

            // pooled fixed-effect
            const W = items.reduce((s, it) => s + (1/it.var), 0);
            if (!(W > 0)) continue;
            const pooled = items.reduce((s,it)=> s + (it.effect/it.var), 0) / W;
            const varP = 1 / W;
            const seP = Math.sqrt(varP);
            const lo = pooled - 1.96*seP;
            const hi = pooled + 1.96*seP;

            const loMin = lo;
            const hiMax = hi;
            const pad = Math.max((hiMax - loMin) * 0.2, 0.5);
            const xMin = loMin - pad;
            const xMax = hiMax + pad;

            const width = 560; const height = 90;
            const px = x => 40 + ( (x - xMin) / (xMax - xMin) ) * (width - 60);

            const tr = document.createElement('tr');
            const tdName = document.createElement('td'); tdName.textContent = g.display; tr.appendChild(tdName);
            const tdCount = document.createElement('td'); tdCount.className = 'nowrap'; tdCount.textContent = String(items.length); tr.appendChild(tdCount);

            const tdSvg = document.createElement('td');
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg'); svg.setAttribute('width', width); svg.setAttribute('height', height); svg.style.maxWidth='100%';
            // zero line
            const zero = document.createElementNS(svgNS, 'line'); zero.setAttribute('x1', px(0)); zero.setAttribute('x2', px(0)); zero.setAttribute('y1', 10); zero.setAttribute('y2', height-10); zero.setAttribute('stroke', '#e5e7eb'); zero.setAttribute('stroke-dasharray', '4 4'); svg.appendChild(zero);
            // axis ticks
            const ticks = 5; for (let i=0;i<=ticks;i++){ const v = xMin + (i/ticks)*(xMax-xMin); const x = px(v); const l = document.createElementNS(svgNS,'line'); l.setAttribute('x1',x); l.setAttribute('x2',x); l.setAttribute('y1',height-18); l.setAttribute('y2',height-10); l.setAttribute('stroke','#9ca3af'); svg.appendChild(l); const t = document.createElementNS(svgNS,'text'); t.setAttribute('x',x); t.setAttribute('y',height-2); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','10'); t.setAttribute('fill','#374151'); t.textContent = (Math.abs(v) < 1e-6 ? '0' : v.toFixed(2)); svg.appendChild(t); }
            // pooled CI and point
            const y = height/2;
            const line = document.createElementNS(svgNS,'line'); line.setAttribute('x1', px(lo)); line.setAttribute('x2', px(hi)); line.setAttribute('y1', y); line.setAttribute('y2', y); line.setAttribute('stroke', '#2563eb'); line.setAttribute('stroke-width','2'); svg.appendChild(line);
            const capL = document.createElementNS(svgNS,'line'); capL.setAttribute('x1', px(lo)); capL.setAttribute('x2', px(lo)); capL.setAttribute('y1', y-6); capL.setAttribute('y2', y+6); capL.setAttribute('stroke', '#2563eb'); svg.appendChild(capL);
            const capR = document.createElementNS(svgNS,'line'); capR.setAttribute('x1', px(hi)); capR.setAttribute('x2', px(hi)); capR.setAttribute('y1', y-6); capR.setAttribute('y2', y+6); capR.setAttribute('stroke', '#2563eb'); svg.appendChild(capR);
            const dot = document.createElementNS(svgNS,'circle'); dot.setAttribute('cx', px(pooled)); dot.setAttribute('cy', y); dot.setAttribute('r', 4); dot.setAttribute('fill', '#2563eb'); dot.setAttribute('stroke','#374151'); dot.setAttribute('stroke-width','0.5'); svg.appendChild(dot);
            const wrap = document.createElement('div'); wrap.className='svg-wrap'; wrap.appendChild(svg); tdSvg.appendChild(wrap); tr.appendChild(tdSvg);

            const tdLegend = document.createElement('td');
            const legend = document.createElement('div'); legend.className='legend';
            // list contributing article titles as legend
            const seen = new Set();
            items.forEach((it) => { const t = (it.title || '').trim(); if (t) seen.add(t); });
            Array.from(seen).sort().forEach(title => {
              const item = document.createElement('span'); item.className='legend-item';
              const sw = document.createElement('span'); sw.className='swatch'; sw.style.background = colorFor(title);
              const lbl = document.createElement('span'); lbl.textContent = title;
              item.appendChild(sw); item.appendChild(lbl); legend.appendChild(item);
            });
            tdLegend.appendChild(legend); tr.appendChild(tdLegend);
            tbody.appendChild(tr);
          }
        }

        async function load(){
          const tid = Toast ? Toast.loading('Caricamento grafici...') : null;
          try {
            db = await DataService.getAll();
            // flatten variables with DOI and title
            const rows = [];
            for (const doi of Object.keys(db)){
              const entry = db[doi];
              const arr = Array.isArray(entry?.dati_variabili) ? entry.dati_variabili : [];
              for (const it of arr) {
                const row = Object.assign({}, it, { _doi: doi, doi, title: getTitle(entry) || doi });
                rows.push(row);
              }
            }
            groups = groupByVariable(rows);
            render();
            if (tid && Toast.update) { Toast.update(tid, 'Grafici pronti', 'success'); setTimeout(()=>Toast.dismiss(tid), 600); }
          } catch (e) {
            console.error('Errore caricamento', e);
            if (Toast && Toast.error) Toast.error('Errore caricamento grafici');
          }
        }

        effectTypeEl.addEventListener('change', render);
        searchVarEl.addEventListener('input', render);
        load();
      })();
    </script>
  </body>
  </html>
